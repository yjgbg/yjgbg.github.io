<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一个不听命于任何人的刺客"><title>以函数式编程思维设计一个通用的数据校验器 | Nothing is true, everything is permitted</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="/css/dark.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">以函数式编程思维设计一个通用的数据校验器</h1><a id="logo" href="/.">Nothing is true, everything is permitted</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">以函数式编程思维设计一个通用的数据校验器</h1><div class="post-meta">2021-09-03</div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="JAVA中现有的数据校验机制"><a href="#JAVA中现有的数据校验机制" class="headerlink" title="JAVA中现有的数据校验机制"></a>JAVA中现有的数据校验机制</h3><p>JSR303,JSR380,Hibernate Validator一整套解决方案</p>
<p><strong>使用方式：</strong>Bean上使用注解来描述校验规则，注解对应的ConstraintValidator中的代码根据规则进行校验</p>
<h4 id="第一个问题：扩展困难"><a href="#第一个问题：扩展困难" class="headerlink" title="第一个问题：扩展困难"></a>第一个问题：扩展困难</h4><p><strong>JSR303的扩展机制：</strong>新建一个注解，然后实现一个对应的ConstraintValidator </p>
<p><strong>问题描述：</strong>这样的扩展机制过于繁琐， ，至少需要创建两个类，然而有效代码可能只有短短几行</p>
<p><strong>现状：</strong>在我们现在的业务代码中，面对引入的库中没有的校验规则，需要扩展时，更多情况下会放弃这套扩展机制，而是如下图中这样，在代码中进行校验</p>
<p><img src="https://yjgbg.github.io/img/fun-valid/img0.png" alt="image-20210329142551881"></p>
<p><strong>结果：</strong>而这种解决方式引发了新问题，校验结果不整齐，通过注解上的规则校验出的结果是BindingResult，自定义校验出的结果又有各式各样的结果返回方式，使得对代码的阅读，理解变得困难</p>
<h4 id="第二个问题：校验规则与数据本身耦合"><a href="#第二个问题：校验规则与数据本身耦合" class="headerlink" title="第二个问题：校验规则与数据本身耦合"></a>第二个问题：校验规则与数据本身耦合</h4><p><strong>问题描述：</strong>校验规则以注解的形式标注在实体上，而实体可能会用在多个接口上，而这多个接口又各自需要有不同的校验规则。</p>
<p><strong>JSR303的解决方案：</strong>分组校验，在注解中使用group分组，然后校验时，只读取某组的注解进行校验。</p>
<p>**不足:**这使得代码的复杂度更进一步上升，阅读代码变得很困难</p>
<p><img src="https://yjgbg.github.io/img/fun-valid/img0.png" alt="image-20210329143215351"></p>
<h4 id="这两个问题的理想解决方案（类似下图这样）："><a href="#这两个问题的理想解决方案（类似下图这样）：" class="headerlink" title="这两个问题的理想解决方案（类似下图这样）："></a>这两个问题的理想解决方案（类似下图这样）：</h4><ol>
<li>校验规则和实体本身解耦</li>
<li>校验规则可组合</li>
<li>并且对校验规则本身的编写不应当比使用注解的方式复杂</li>
<li>可以很好的描述复杂逻辑（至少强于注解）</li>
<li>以及良好的可扩展性（加入新的校验规则）</li>
</ol>
<p><img src="https://yjgbg.github.io/img/fun-valid/img0.png" alt="image-20210329143622530"></p>
<p>函数指数学中的“函数”，代表的是<strong>从自变量到因变量的映射</strong></p>
<p>那么校验可以看作：<strong>数据对象（自变量）到Errors类型（因变量）的映射</strong>(有的对象校验完之后可能是没有错误的，应该用一个特定的错误类型对象，如ZERO或者NONE)</p>
<p>而<strong>校验器本身是校验的规则</strong></p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="空校验器"><a href="#空校验器" class="headerlink" title="空校验器"></a>空校验器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 既然校验器是一个从数据对象到Errors类型的映射，那么：</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Validator</span>&lt;<span class="title">A</span>&gt; <span class="keyword">extends</span> <span class="title">Function</span>&lt;<span class="title">A</span>,<span class="title">Errors</span>&gt;</span></span><br><span class="line"><span class="class">// 空校验器与空错误，定义如下：</span></span><br><span class="line"><span class="class">// 空错误</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">Error</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Error NONE = <span class="keyword">new</span> Error(); </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Error <span class="title">none</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> NONE;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 空校验器</span></span><br><span class="line">Validator&lt;A&gt; none = obj -&gt; Errors.none();</span><br></pre></td></tr></table></figure>

<h3 id="简单校验器"><a href="#简单校验器" class="headerlink" title="简单校验器"></a>简单校验器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新Errors定义如下</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Error</span> </span>&#123;</span><br><span class="line">  Object rejectValue;</span><br><span class="line">  String message;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> Error <span class="title">none</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> Error <span class="title">simple</span><span class="params">(Object rejectValue,String message)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//创建一个简单字符串校验器，校验字符串长度不大于5</span></span><br><span class="line">Validator&lt;String&gt; stringValidator = str -&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span>(str.length() &lt;= <span class="number">5</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> Errors.none();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> Errors.simple(str,<span class="string">&quot;长度大于5&quot;</span>);<span class="comment">// 第一个参数为错误的值，第二个参数为对应的信息</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//创建一个简单对象校验器，校验对象不为空</span></span><br><span class="line">Validator&lt;Object&gt; stringValidator = obj -&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span>(obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> Errors.none();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> Errors.simple(str,<span class="string">&quot;对象不可为空&quot;</span>);<span class="comment">// 第一个参数为错误的值，第二个参数为对应的信息</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 观察，发现，简单校验器具有都具有相似的结构，由一个布尔表达式判断是否有错，</span></span><br><span class="line"><span class="comment">// 如果有错则用被检验的目标对象和一个字符串创建一个错误，于是抽象简单校验器如下</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Validator&lt;A&gt; <span class="title">simple</span><span class="params">(String message,Predicate&lt;A&gt; constraint)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a -&gt; constraint.test(a) ? Errors.none() : Errors.simple(a,message);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 简单对象的校验</span></span><br><span class="line">Validator&lt;String&gt; lengthGt3 = Validator.simple(<span class="string">&quot;长度应当小于3&quot;</span>,str -&gt; str.length &lt;<span class="number">3</span>);</span><br><span class="line">lengthGt3.apply(<span class="string">&quot;alice&quot;</span>); <span class="comment">// Errors.none();</span></span><br><span class="line">lengthGt3.apply(<span class="string">&quot;xm&quot;</span>); <span class="comment">// Errors.simple(&quot;xm&quot;,&quot;长度应当小于3&quot;);</span></span><br></pre></td></tr></table></figure>



<h3 id="两类复杂校验器"><a href="#两类复杂校验器" class="headerlink" title="两类复杂校验器"></a>两类复杂校验器</h3><h4 id="A类复杂校验器"><a href="#A类复杂校验器" class="headerlink" title="A类复杂校验器"></a>A类复杂校验器</h4><p><strong>，已有一个校验规则为string长度小于3的校验器lengthGt3和规则为不带有空格的校验器havNotBlank,需要一个校验规则为string长度小于3，并且不带有空格的校验器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 校验器lengthGt3：长度小于3</span></span><br><span class="line">Validator&lt;String&gt; lengthGt3 = Validator.of(<span class="string">&quot;长度应当小于3&quot;</span>,str -&gt; str.length &lt;<span class="number">3</span>);</span><br><span class="line"><span class="comment">// 校验器havNotBlank:不含有空格</span></span><br><span class="line">Validator&lt;String&gt; havNotBlank = Validator.of(<span class="string">&quot;应当没有空格&quot;</span>,str -&gt; Objects.equals(str,str.replaceAll(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>)));</span><br><span class="line"><span class="comment">// 所需要的校验器应该是上面两个校验器相加</span></span><br><span class="line">Validator&lt;String&gt; plus = Validator.plus(lengthGt3,noBlank);<span class="comment">// 需要有这样一个函数，将两个校验器的规则加起来</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 思路：两个校验器（v0，v1）分别校验，然后将各自的校验结果相加。</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Validator&lt;A&gt; <span class="title">plus</span><span class="params">(Validator&lt;A&gt; v0,Validator&lt;A&gt; v1)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a -&gt; Errors.plus(v0.apply(a),v1.apply(a));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 前面定义的简单错误已经不够用了，我们需要可以相加的错误（A类复杂错误），需要可以容纳多条message</span></span><br></pre></td></tr></table></figure>

<h4 id="A类复杂错误"><a href="#A类复杂错误" class="headerlink" title="A类复杂错误"></a>A类复杂错误</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考虑Errors的结构</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Errors</span> </span>&#123;</span><br><span class="line">  Object rejectValue;</span><br><span class="line">  Set&lt;String&gt; message;</span><br><span class="line">  <span class="comment">// 提供如下构造方式:</span></span><br><span class="line">  <span class="function">publib <span class="keyword">static</span> Errors <span class="title">none</span><span class="params">()</span></span>; <span class="comment">// 表示该对象没有错误</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Errors <span class="title">simple</span><span class="params">(Object rejectValue,String message)</span></span>; <span class="comment">// 表示该对象发生了一个错误，两个参数为该对象，和错误信息</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Errors <span class="title">plus</span><span class="params">(Errors e0,Errors e1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> rejectvalue0 == rejectvalue1;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Error(rejectValue0,Set.union(message0,message1));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将这种复杂错误成为A类复杂错误: 有rejectValue，且message集合中有多个元素的错误</span></span><br></pre></td></tr></table></figure>

<h4 id="B类复杂校验器"><a href="#B类复杂校验器" class="headerlink" title="B类复杂校验器"></a>B类复杂校验器</h4><p>已有校验器<code>Validator&lt;String&gt; lengthGt3</code>,需要构造校验器<code>Validator&lt;Entity1&gt;</code>，</p>
<p>要求对Entity1中的字段String name的校验规则为lengthGt3</p>
<p>其中Entity1定义如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Entity1</span> </span>&#123;</span><br><span class="line">  String name;</span><br><span class="line">&#125;</span><br><span class="line">Validator&lt;String&gt; lengthGt3 = Validator.of(<span class="string">&quot;长度应当小于3&quot;</span>,str -&gt; str.length &lt;<span class="number">3</span>); <span class="comment">//这是已经有的校验器</span></span><br><span class="line">求: Validator&lt;Entity1&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此时需要一个变换函数，可以使得校验器在不同的目标类型之间变换，关键在于转换结果的变换</span></span><br><span class="line"><span class="comment">// 要创建一个变化函数，则需要一个参数，可以表达出name这个属性的属性名以及如何取值</span></span><br><span class="line"><span class="comment">// 知识点:Getter.propertyName</span></span><br><span class="line"><span class="comment">// 如下：将A对象转化为B对象，使用origin进行校验，校验之后将返回的Errors结果转换回来</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Validator&lt;A&gt; <span class="title">transform</span><span class="params">(Getter&lt;A,B&gt; prop,Validator&lt;B&gt; origin)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a -&gt; Errors.transform(prop.propertyName(),origin.apply(prop.apply(a)))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 此时Errors的定义又不够用，需要一个可以进行transform运算的Errors</span></span><br></pre></td></tr></table></figure>

<h4 id="B类复杂错误"><a href="#B类复杂错误" class="headerlink" title="B类复杂错误"></a>B类复杂错误</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//思考Errors的结构，需要可以表示属性错误</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Errors</span> </span>&#123; <span class="comment">// 完全体的错误对象</span></span><br><span class="line">  Object rejectValue;</span><br><span class="line">  Set&lt;String&gt; message;</span><br><span class="line">  Map&lt;String,Errors&gt; fieldErrors;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 提供如下构造方式:</span></span><br><span class="line"><span class="function">publib <span class="keyword">static</span> Errors <span class="title">none</span><span class="params">()</span></span>; <span class="comment">// 表示该对象没有错误</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Errors <span class="title">simple</span><span class="params">(Object rejectValue,String message)</span></span>; <span class="comment">// 表示该对象发生了一个错误，两个参数为该对象，和错误信息</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Errors <span class="title">plus</span><span class="params">(Errors e0,Errors e1)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Errors <span class="title">transform</span><span class="params">(String prop,Errors origin)</span> </span>&#123; <span class="comment">// 以上面的例子理解：String类型的校验错误，转换成</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Errors(<span class="keyword">null</span>,Set.empty(),Map.of(prop,origin));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将这种复杂错误成为B类复杂错误，</span></span><br></pre></td></tr></table></figure>

<h3 id="阶段总结"><a href="#阶段总结" class="headerlink" title="阶段总结"></a>阶段总结</h3><p>Errors对象应该有4种构造方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">publib <span class="keyword">static</span> Errors <span class="title">none</span><span class="params">()</span></span>; <span class="comment">// 空错误</span></span><br><span class="line"><span class="comment">// 简单错误：只有rejectValue和message有值，且message为只有一个元素的set</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Errors <span class="title">simple</span><span class="params">(Object rejectValue,String message)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Errors <span class="title">plus</span><span class="params">(Errors err0,Errors err1)</span></span>; <span class="comment">// A类复杂错误</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Errors <span class="title">transform</span><span class="params">(String prop,Errors errors)</span></span>; <span class="comment">// B类复杂错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//其中transform和plus甚至是满足transform对plus的分配律的。即：</span></span><br><span class="line">plus(transform(prop,a),transform(prop,b)) === transform(prop,plus(a,b))</span><br></pre></td></tr></table></figure>

<p>对应校验器有4种构造方式:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 空校验器:无论如何校验结果都为Errors.none(),空错误</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Validator&lt;A&gt; <span class="title">none</span><span class="params">()</span></span>; </span><br><span class="line"><span class="comment">// 简单校验器：校验结果为简单错误</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Validator&lt;A&gt; <span class="title">simple</span><span class="params">(String message,Predicate&lt;A&gt; constraint)</span></span>;</span><br><span class="line"><span class="comment">// A类复杂校验器：校验结果为A类复杂错误</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Validator&lt;A&gt; <span class="title">plus</span><span class="params">(Validator&lt;A&gt; validator0,Validator&lt;A&gt; validator1)</span></span>;</span><br><span class="line"><span class="comment">// B类复杂校验器：校验结果为B类复杂错误</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Validator&lt;A&gt; <span class="title">transform</span><span class="params">(Getter&lt;A,B&gt; prop,Validator&lt;B&gt; validator0)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// transform和plus也是满足transform对plus的分配律的。即：</span></span><br><span class="line">plus(transform(prop,a),transform(prop,b)) === transform(prop,plus(a,b))</span><br></pre></td></tr></table></figure>

<h3 id="新的问题"><a href="#新的问题" class="headerlink" title="新的问题"></a>新的问题</h3><p>根据如上4个校验器的构造方式：</p>
<p>我们可以构造出各种各样的校验器，而且理论似乎接近完美，但是，像下面这样只通过这4个构造方式去构造复杂校验器，与我们理想中的校验器却相差甚远</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明要校验的目标</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">var</span> entity0 = <span class="keyword">new</span> SampleEntity( <span class="number">0L</span>,<span class="string">&quot;l&quot;</span>, Gender.MALE,<span class="string">&quot;12345678910&quot;</span>,<span class="string">&quot;abc@def.com&quot;</span>);</span><br><span class="line"><span class="comment">// 先声明若干个属性类型的校验器</span></span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> nonNull = Validator.&lt;SampleEntity&gt;simple(Objects::nonNull,<span class="string">&quot;person不能为空&quot;</span>);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> idValidator = Validator.&lt;Long&gt;simple( id -&gt; id!=<span class="keyword">null</span> &amp;&amp; id &gt; <span class="number">0L</span>,<span class="string">&quot;id应该大于0&quot;</span>);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> nameValidator = Validator.&lt;String&gt;simple(name -&gt; name!=<span class="keyword">null</span> &amp;&amp; name.length() &gt;= <span class="number">2</span> &amp;&amp; name.length() &lt;<span class="number">5</span><span class="string">&quot;name应该是2-5个字&quot;</span>);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> genderValidator = Validator.&lt;Gender&gt;simple(gender -&gt; Objects.equals(gender,Gender.FEMALE),<span class="string">&quot;应该是女性&quot;</span>);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> phoneValidator = Validator.&lt;String&gt;simple(x -&gt; x == <span class="keyword">null</span> || Pattern.matches(<span class="string">&quot;^\\d&#123;11&#125;$&quot;</span>,x),<span class="string">&quot;电话号码应该为11位数字&quot;</span>);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> emailValidator = Validator.&lt;String&gt;simple(x -&gt; x != <span class="keyword">null</span> &amp;&amp; Pattern.matches(<span class="string">&quot;^\\w+([-+.]\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$&quot;</span>,x),<span class="string">&quot;email格式非法&quot;</span>);</span><br><span class="line"><span class="comment">// 将它们transform到目标实体类SampleEntity</span></span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> id = Validator.transform(SampleEntity::getId,idValidator);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> name = Validator.transform(SampleEntity::getName,nameValidator);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> gender = Validator.transform(SampleEntity::getGender,genderValidator);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> phone = Validator.transform(SampleEntity::getPhone,phoneValidator);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> email = Validator.transform(SampleEntity::getEmail,emailValidator);</span><br><span class="line"><span class="comment">// 再将这些校验器相加</span></span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> validator0 = Validator.plus(nonNull,id);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> validator1 = Validator.plus(validator0,name);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> validator2 = Validator.plus(validator1,gender);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> validator3 = Validator.plus(validator2,phone);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> validator4 = Validator.plus(validator3,email);</span><br><span class="line"><span class="comment">// 对目标对象进行校验</span></span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> errors0 = validator4.apply(entity0);</span><br><span class="line"><span class="comment">// 这样的代码既不好写，也不好读</span></span><br></pre></td></tr></table></figure>

<p>因此，需要一些胶水代码（如下），封装一些易用的API，使我们生活可以不这么艰难</p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p><a target="_blank" rel="noopener" href="https://projectlombok.org/features/experimental/ExtensionMethod">lombok的ExtensionMethod特性</a> ：允许给已经存在的类添加实例方法</p>
<p>原理： 编译期修改代码，将不存在的实例方法调用转换为对应的静态方法调用</p>
<p>定义如下扩展：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;A&gt; <span class="function">Validator&lt;A&gt; <span class="title">and</span><span class="params">(Validator&lt;A&gt; that, Validator&lt;? <span class="keyword">super</span> A&gt; validator)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Validator.plus(that, validator);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;A&gt; <span class="function">Validator&lt;A&gt; <span class="title">and</span><span class="params">(Validator&lt;A&gt; that, String message, Predicate&lt;<span class="meta">@Nullable</span> A&gt; constraint)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Validator.plus(that, Validator.simple(message, constraint);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;A, B&gt; <span class="function">Validator&lt;A&gt; <span class="title">and</span><span class="params">(Validator&lt;A&gt; that, Getter&lt;A, B&gt; prop, Validator&lt;B&gt; another)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Validator.plus(that, Validator.transform(prop, another));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;A, B&gt; <span class="function">Validator&lt;A&gt; <span class="title">and</span><span class="params">(Validator&lt;A&gt; that, Getter&lt;A, B&gt; prop, String message,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      Predicate&lt;<span class="meta">@Nullable</span> B&gt; constraint)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Validator.plus(that, Validator.transform(prop, Validator.of(message,constraint)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这些扩展函数，我们可以将上面but下面的那一大段用如下的方式表达：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">var</span> entity0 = <span class="keyword">new</span> SampleEntity( <span class="number">0L</span>,<span class="string">&quot;l&quot;</span>, Gender.MALE,<span class="string">&quot;12345678910&quot;</span>,<span class="string">&quot;abc@def.com&quot;</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">var</span> validator0 = Validator.&lt;SampleEntity&gt;none()</span><br><span class="line">		.and(<span class="string">&quot;person不能为空&quot;</span>, Objects::nonNull)</span><br><span class="line">		.and(SampleEntity::getId,<span class="string">&quot;id应该大于0,而不是%s&quot;</span>, id -&gt; id!=<span class="keyword">null</span> &amp;&amp; id &gt; <span class="number">0L</span>)</span><br><span class="line">		.and(SampleEntity::getName,<span class="string">&quot;name应该是2-5个字&quot;</span>, name -&gt; name!=<span class="keyword">null</span> &amp;&amp; name.length() &gt;= <span class="number">2</span> &amp;&amp; name.length() &lt;<span class="number">5</span>)</span><br><span class="line">		.and(SampleEntity::getGender,<span class="string">&quot;应该是女性&quot;</span>, gender -&gt; Objects.equals(gender,Gender.FEMALE))</span><br><span class="line">		.and(SampleEntity::getPhone,<span class="string">&quot;电话号码应该为11位数字&quot;</span>, x -&gt; x == <span class="keyword">null</span> || Pattern.matches(<span class="string">&quot;^\\d&#123;11&#125;$&quot;</span>,x))</span><br><span class="line">		.and(SampleEntity::getEmail,  <span class="string">&quot;email格式非法&quot;</span>, x -&gt;</span><br><span class="line">				x != <span class="keyword">null</span> &amp;&amp; Pattern.matches(<span class="string">&quot;^\\w+([-+.]\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$&quot;</span>,x));</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">var</span> errors0 = validator0.apply(<span class="keyword">false</span>,entity0);</span><br><span class="line">System.out.println(errors0.toMessageMap());</span><br></pre></td></tr></table></figure>



<p>常用的校验函数:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yjgbg/fun-valid/blob/simplify/src/main/java/com/github/yjgbg/fun/valid/ext/LbkExtValidatorsStd.java">LbkExtValidatorsStd.java</a></p>
<p>再次简化如上代码(从代码量上看，这一层的简化并没有啥效果，不过代码的可读性获得了比较高的提升):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">var</span> entity1 = <span class="keyword">new</span> SampleEntity( <span class="number">0L</span>,<span class="string">&quot;null&quot;</span>, Gender.FEMALE,<span class="string">&quot;1234567891011&quot;</span>,<span class="string">&quot;asdqq.com&quot;</span>);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> validator1 =Validator.&lt;SampleEntity&gt;none()</span><br><span class="line">				.nonNull(<span class="string">&quot;person不能为空&quot;</span>)</span><br><span class="line">				.gt(SampleEntity::getId,<span class="string">&quot;id应该大于0&quot;</span>,<span class="number">0L</span>)</span><br><span class="line">				.length(SampleEntity::getName,<span class="string">&quot;name应该是2-5个字&quot;</span>,<span class="number">2</span>,<span class="number">5</span>)</span><br><span class="line">				.equal(SampleEntity::getGender,<span class="string">&quot;应该是男性&quot;</span>,Gender.MALE)</span><br><span class="line">				.regexp(SampleEntity::getPhone,<span class="string">&quot;电话号码不合法&quot;</span>, <span class="keyword">true</span>, <span class="string">&quot;^\\d&#123;11&#125;$&quot;</span>)</span><br><span class="line">				.regexp(SampleEntity::getEmail,<span class="string">&quot;email不合法&quot;</span>, <span class="keyword">false</span>,</span><br><span class="line">						<span class="string">&quot;^\\w+([-+.]\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$&quot;</span>);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">var</span> errors1 = validator1.apply(<span class="keyword">false</span>,entity1);</span><br><span class="line">		System.out.println(errors1.toMessageMap());</span><br></pre></td></tr></table></figure>

<h2 id="大功告成"><a href="#大功告成" class="headerlink" title="大功告成"></a>大功告成</h2><h4 id="maven引入依赖"><a href="#maven引入依赖" class="headerlink" title="maven引入依赖"></a>maven引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.yjgbg<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fun-valid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>ROLLING-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h4><p><a target="_blank" rel="noopener" href="https://com-github-yjgbg.github.io/fun-valid/">fun-valid javadoc文档</a><br><a target="_blank" rel="noopener" href="https://github.com/com-github-yjgbg/fun-valid.git">fun-valid github 地址</a></p>
</div><div class="tags"></div><div class="post-nav"><a class="next" href="/2021/09/03/hello-world/">Hello World</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://yjgbg.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/09/03/fun-valid/">以函数式编程思维设计一个通用的数据校验器</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/03/hello-world/">Hello World</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Nothing is true, everything is permitted.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>